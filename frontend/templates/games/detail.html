{% extends 'base.html' %}

{% block title %}{{ game.name }} - Top-up Game | TOPUPGAMEMOBILE{% endblock %}

{% block meta_description %}Top-up {{ game.name }} instantly with best prices. Secure payment via USDT TRC20 or internal wallet. Fast delivery guaranteed.{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li><a href="/" class="text-dark-400 hover:text-primary-400 transition-colors">Home</a></li>
            <li><i class="fas fa-chevron-right text-dark-600 text-xs"></i></li>
            <li><a href="/games/" class="text-dark-400 hover:text-primary-400 transition-colors">Games</a></li>
            <li><i class="fas fa-chevron-right text-dark-600 text-xs"></i></li>
            <li class="text-white" id="breadcrumbGameName">Loading...</li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Game Info Sidebar -->
        <div class="lg:col-span-1">
            <div class="card p-6 sticky top-24">
                <img id="gameImage" class="w-full rounded-xl mb-4" src="" alt="">
                <h1 id="gameName" class="text-2xl font-bold text-white mb-2"></h1>
                <p id="gameDescription" class="text-dark-400 mb-4"></p>
                <div class="flex items-center justify-between pt-4 border-t border-dark-700">
                    <span class="text-dark-400">Status:</span>
                    <span id="gameStatus" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                </div>
            </div>
        </div>

        <!-- Order Form -->
        <div class="lg:col-span-2">
            <div class="card p-6 md:p-8">
                <h2 class="text-2xl font-bold text-white mb-6">
                    <i class="fas fa-shopping-cart text-primary-400 mr-2"></i>
                    Create Top-up Order
                </h2>

                <form id="orderForm" class="space-y-6">
                    <!-- Package Selection -->
                    <div id="packageSection">
                        <label class="form-label">
                            <i class="fas fa-box mr-1"></i>
                            Select Package <span class="text-red-400">*</span>
                        </label>

                        <!-- Package Type Tabs -->
                        <div class="flex space-x-2 mb-4">
                            <button type="button" id="normalTab" class="flex-1 px-4 py-2 rounded-lg font-semibold transition bg-primary-600 text-white">
                                <i class="fas fa-box mr-2"></i>Normal
                            </button>
                            <button type="button" id="warrantyTab" class="flex-1 px-4 py-2 rounded-lg font-semibold transition bg-dark-700 text-dark-300 hover:bg-dark-600">
                                <i class="fas fa-shield-alt mr-2"></i>Warranty
                            </button>
                        </div>

                        <!-- Package Grids -->
                        <div id="normalPackages" class="package-container">
                            <div id="normalPackageGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                            <div id="normalPackagesEmpty" class="hidden text-center py-8 text-dark-400">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>No normal packages available</p>
                            </div>
                        </div>

                        <div id="warrantyPackages" class="package-container hidden">
                            <div id="warrantyPackageGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                            <div id="warrantyPackagesEmpty" class="hidden text-center py-8 text-dark-400">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>No warranty packages available</p>
                            </div>
                        </div>

                        <!-- <p class="mt-3 text-sm text-dark-400">
                            <i class="fas fa-info-circle mr-1 text-primary-400"></i>
                            <strong>Warranty Package:</strong> 100% money-back guarantee if system error occurs
                        </p> -->

                        <!-- Policy Agreement Checkbox -->
                        <div class="mt-4 p-4 bg-dark-700/50 rounded-lg border border-dark-600">
                            <label class="flex items-start cursor-pointer group">
                                <input type="checkbox" id="policyAgreement" checked class="mt-1 mr-3 w-4 h-4 text-primary-600 bg-dark-700 border-dark-500 rounded focus:ring-primary-500 focus:ring-2">
                                <span class="text-sm text-dark-300 group-hover:text-dark-200">
                                    I agree to the
                                    <a href="/refund/" target="_blank" class="text-primary-400 hover:text-primary-300 underline">
                                        Warranty Policy
                                    </a>
                                    of TopUpGameMobile
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Game Account Info -->
                    <div class="pt-6 border-t border-dark-700">
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-gamepad mr-2 text-pink-400"></i>
                            Game Account Information
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">UID / Account ID <span class="text-red-400">*</span></label>
                                <input type="text" id="gameUid" placeholder="Enter UID or account ID" required class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Login Username <span class="text-red-400">*</span></label>
                                <input type="text" id="gameUsername" placeholder="Game account username" required class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Password <span class="text-red-400">*</span></label>
                                <input type="password" id="gamePassword" placeholder="Game account password" required class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Character Name <span class="text-red-400">*</span></label>
                                <input type="text" id="characterName" placeholder="Character name in game" required class="form-input">
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-500/10 rounded-lg border border-yellow-500/20">
                            <p class="text-xs text-yellow-400">
                                <i class="fas fa-shield-alt mr-1"></i>
                                <strong>Security:</strong> Your account information is encrypted and only used for top-up purposes.
                            </p>
                        </div>
                    </div>

                    <!-- Note -->
                    <div>
                        <label class="form-label">Note (Optional)</label>
                        <textarea id="customerNote" rows="3" placeholder="Notes for admin..." class="form-input"></textarea>
                    </div>

                    <!-- Payment Method -->
                    <div>
                        <label class="form-label">Payment Method <span class="text-red-400">*</span></label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="payment-method cursor-pointer">
                                <input type="radio" name="paymentMethod" value="wallet" class="hidden">
                                <div class="card p-4 hover:border-primary-500 transition-colors text-center">
                                    <i class="fas fa-wallet text-2xl text-primary-400 mb-2"></i>
                                    <p class="font-semibold text-white">Internal Wallet</p>
                                    <p class="text-sm text-dark-400">Balance: <span id="walletBalance">$0.00</span></p>
                                </div>
                            </label>
                            <label class="payment-method cursor-pointer">
                                <input type="radio" name="paymentMethod" value="crypto" class="hidden">
                                <div class="card p-4 hover:border-primary-500 transition-colors text-center">
                                    <i class="fab fa-bitcoin text-2xl text-yellow-500 mb-2"></i>
                                    <p class="font-semibold text-white">Crypto</p>
                                    <p class="text-sm text-dark-400">USDT TRC20</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="bg-gradient-to-r from-primary-600/20 to-pink-600/20 rounded-xl p-6 border border-primary-500/30">
                        <div id="packageSummary" class="hidden mb-4 pb-4 border-b border-primary-500/30">
                            <p class="text-sm text-dark-400 mb-1">Selected package:</p>
                            <p class="font-semibold text-lg text-white" id="selectedPackageName">-</p>
                            <p class="text-sm text-dark-400">
                                <span id="selectedPackageAmount">0</span> <span id="selectedPackageUnit">-</span>
                            </p>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-dark-300 font-medium">Total Amount:</span>
                            <span class="text-3xl font-bold text-white" id="totalUSD">$0.00</span>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full btn btn-primary btn-glow text-lg py-4" id="submitBtn" disabled>
                        <i class="fas fa-check-circle mr-2"></i>
                        Create Order
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Game Introduction -->
    <div id="gameIntroductionSection" class="hidden mt-8">
        <div class="card p-6 md:p-8">
            <h2 class="text-2xl font-bold text-white mb-6">
                <i class="fas fa-info-circle text-primary-400 mr-2"></i>
                <span id="introductionTitle">About This Game</span>
            </h2>
            <div id="gameIntroduction" class="prose prose-invert max-w-none text-dark-300"></div>
        </div>
    </div>
</div>

<script>
let gameData = null;
let selectedPackage = null;
let packagesData = { normal: [], warranty: [] };

document.addEventListener('DOMContentLoaded', function() {
    const slug = window.location.pathname.split('/')[2];
    loadGameDetail(slug);
    loadWalletBalance();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('normalTab')?.addEventListener('click', () => switchPackageTab('normal'));
    document.getElementById('warrantyTab')?.addEventListener('click', () => switchPackageTab('warranty'));

    document.querySelectorAll('.payment-method').forEach(label => {
        label.addEventListener('click', function() {
            document.querySelectorAll('.payment-method .card').forEach(div => {
                div.classList.remove('border-primary-500', 'bg-primary-500/10');
            });
            this.querySelector('.card').classList.add('border-primary-500', 'bg-primary-500/10');
        });
    });

    document.getElementById('orderForm')?.addEventListener('submit', handleOrderSubmit);
}

function switchPackageTab(type) {
    const normalTab = document.getElementById('normalTab');
    const warrantyTab = document.getElementById('warrantyTab');

    if (type === 'normal') {
        normalTab.classList.remove('bg-dark-700', 'text-dark-300');
        normalTab.classList.add('bg-primary-600', 'text-white');
        warrantyTab.classList.remove('bg-primary-600', 'text-white');
        warrantyTab.classList.add('bg-dark-700', 'text-dark-300');
        document.getElementById('normalPackages').classList.remove('hidden');
        document.getElementById('warrantyPackages').classList.add('hidden');
    } else {
        warrantyTab.classList.remove('bg-dark-700', 'text-dark-300');
        warrantyTab.classList.add('bg-primary-600', 'text-white');
        normalTab.classList.remove('bg-primary-600', 'text-white');
        normalTab.classList.add('bg-dark-700', 'text-dark-300');
        document.getElementById('warrantyPackages').classList.remove('hidden');
        document.getElementById('normalPackages').classList.add('hidden');
    }
}

function loadGameDetail(slug) {
    fetch(`/api/games/${slug}/`)
        .then(response => {
            if (!response.ok) throw new Error('Unable to load game info');
            return response.json();
        })
        .then(game => {
            gameData = game;
            displayGameInfo(game);
            loadGamePackages(slug);
        })
        .catch(error => {
            console.error('Error:', error);
            window.modal?.error('Error', 'Unable to load game information', {
                actions: [{
                    label: 'Go Back',
                    style: 'primary',
                    onClick: () => window.location.href = '/games/'
                }]
            });
        });
}

function loadGamePackages(slug) {
    fetch(`/api/games/${slug}/packages/`)
        .then(response => {
            if (!response.ok) throw new Error('Unable to load packages');
            return response.json();
        })
        .then(data => {
            packagesData = data.packages;
            displayPackages('normal', packagesData.normal);
            displayPackages('warranty', packagesData.warranty);
        })
        .catch(error => console.error('Error loading packages:', error));
}

function displayGameInfo(game) {
    document.getElementById('gameImage').src = game.image || '/static/images/game-placeholder.png';
    document.getElementById('gameName').textContent = game.name;
    document.getElementById('breadcrumbGameName').textContent = game.name;
    document.getElementById('gameDescription').textContent = game.description;

    const statusSpan = document.getElementById('gameStatus');
    if (game.status === 'active') {
        statusSpan.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-500/20 text-green-400';
        statusSpan.textContent = 'Active';
    } else if (game.status === 'maintenance') {
        statusSpan.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-yellow-500/20 text-yellow-400';
        statusSpan.textContent = 'Maintenance';
    } else {
        statusSpan.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-dark-600 text-dark-300';
        statusSpan.textContent = 'Inactive';
    }

    if (game.introduction && game.introduction.trim() !== '') {
        document.getElementById('introductionTitle').textContent = `About ${game.name}`;
        document.getElementById('gameIntroduction').innerHTML = game.introduction;
        document.getElementById('gameIntroductionSection').classList.remove('hidden');
    }
}

function displayPackages(type, packages) {
    const gridId = type === 'normal' ? 'normalPackageGrid' : 'warrantyPackageGrid';
    const emptyId = type === 'normal' ? 'normalPackagesEmpty' : 'warrantyPackagesEmpty';
    const grid = document.getElementById(gridId);
    const empty = document.getElementById(emptyId);

    grid.innerHTML = '';

    if (!packages || packages.length === 0) {
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');

    packages.forEach(pkg => {
        const div = document.createElement('div');
        const isWarranty = pkg.package_type === 'warranty';

        div.className = `package-item card p-3 cursor-pointer hover:border-primary-500 transition-all text-center ${isWarranty ? 'bg-yellow-500/5' : ''}`;
        div.dataset.packageId = pkg.id;
        div.dataset.packageType = pkg.package_type;

        div.innerHTML = `
            <p class="font-semibold text-sm mb-1 text-white truncate" title="${pkg.name}">${pkg.name}</p>
            <p class="text-primary-400 font-bold text-lg mb-1">${formatCurrency(pkg.price_usd)}</p>
            <div class="text-xs text-dark-400">
                <i class="fas fa-coins mr-1"></i>
                <span class="font-semibold">${formatNumber(pkg.in_game_amount)}</span>
            </div>
            ${isWarranty ? '<p class="text-[10px] text-yellow-400 mt-1"><i class="fas fa-shield-alt mr-1"></i>Warranty</p>' : ''}
        `;

        div.onclick = () => selectPackage(pkg);
        grid.appendChild(div);
    });
}

function selectPackage(pkg) {
    selectedPackage = pkg;

    document.querySelectorAll('.package-item').forEach(el => {
        el.classList.remove('border-primary-500', 'bg-primary-500/10', 'ring-2', 'ring-primary-500/50');
    });

    const selectedEl = document.querySelector(`[data-package-id="${pkg.id}"]`);
    if (selectedEl) {
        selectedEl.classList.add('border-primary-500', 'ring-2', 'ring-primary-500/50');
        if (pkg.package_type !== 'warranty') {
            selectedEl.classList.add('bg-primary-500/10');
        }
    }

    document.getElementById('packageSummary').classList.remove('hidden');
    document.getElementById('selectedPackageName').textContent = pkg.name;
    document.getElementById('selectedPackageAmount').textContent = formatNumber(pkg.in_game_amount);
    document.getElementById('selectedPackageUnit').textContent = pkg.in_game_unit_label;
    document.getElementById('totalUSD').textContent = formatCurrency(pkg.price_usd);
    document.getElementById('submitBtn').disabled = false;
}

function loadWalletBalance() {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    fetch('/api/wallets/', {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('walletBalance').textContent = formatCurrency(data.balance);
    })
    .catch(error => console.error('Error loading wallet:', error));
}

function handleOrderSubmit(e) {
    e.preventDefault();

    const token = localStorage.getItem('access_token');
    if (!token) {
        window.modal?.warning('Login Required', 'Please login to create an order', {
            actions: [{
                label: 'Login',
                style: 'primary',
                onClick: () => window.location.href = '/login/'
            }]
        });
        return;
    }

    if (!selectedPackage) {
        window.modal?.error('Missing Information', 'Please select a package');
        return;
    }

    const gameUid = document.getElementById('gameUid').value.trim();
    const gameUsername = document.getElementById('gameUsername').value.trim();
    const gamePassword = document.getElementById('gamePassword').value.trim();
    const characterName = document.getElementById('characterName').value.trim();
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;

    if (!gameUid || !gameUsername || !gamePassword || !characterName) {
        window.modal?.error('Missing Information', 'Please fill in all required fields');
        return;
    }

    if (!paymentMethod) {
        window.modal?.error('Missing Information', 'Please select payment method');
        return;
    }

    const policyAgreement = document.getElementById('policyAgreement').checked;
    if (!policyAgreement) {
        window.modal?.error('Policy Agreement Required', 'Vui lòng đồng ý với chính sách bảo hành để tiếp tục');
        return;
    }

    const formData = {
        game: gameData.id,
        game_package: selectedPackage.id,
        game_uid: gameUid,
        game_username: gameUsername,
        game_password: gamePassword,
        character_name: characterName,
        customer_note: document.getElementById('customerNote').value,
        payment_method: paymentMethod
    };

    showOrderConfirmation(formData, paymentMethod);
}

function showOrderConfirmation(formData, paymentMethod) {
    const paymentMethodText = paymentMethod === 'wallet' ? 'Internal Wallet' : 'Crypto (USDT TRC20)';

    window.modal?.show({
        type: 'question',
        title: 'Confirm Order',
        message: 'Please review your information:',
        html: `
            <div class="mt-4 p-4 bg-dark-700 rounded-lg">
                <p class="text-sm text-dark-300 mb-2"><strong class="text-white">Game:</strong> ${gameData.name}</p>
                <p class="text-sm text-dark-300 mb-2"><strong class="text-white">Package:</strong> ${selectedPackage.name}</p>
                <p class="text-sm text-dark-300 mb-2"><strong class="text-white">Amount:</strong> <span class="text-primary-400 font-bold">${formatCurrency(selectedPackage.price_usd)}</span></p>
                <p class="text-sm text-dark-300 mb-2"><strong class="text-white">Account:</strong> ${formData.game_username}</p>
                <p class="text-sm text-dark-300"><strong class="text-white">Payment:</strong> ${paymentMethodText}</p>
            </div>
        `,
        actions: [
            { label: 'Cancel', style: 'secondary' },
            { label: 'Confirm', style: 'primary', onClick: () => createOrder(formData, paymentMethod) }
        ]
    });
}

function createOrder(formData, paymentMethod) {
    const token = localStorage.getItem('access_token');

    window.modal?.show({
        type: 'info',
        title: 'Processing...',
        message: 'Please wait',
        html: '<div class="flex justify-center py-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div></div>',
        actions: []
    });

    fetch('/api/orders/create/', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.detail || err.error || 'Unable to create order');
            });
        }
        return response.json();
    })
    .then(orderData => {
        return fetch(`/api/orders/${orderData.order_id}/payment/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ payment_method: paymentMethod })
        })
        .then(payResponse => {
            if (!payResponse.ok) {
                return payResponse.json().then(err => {
                    throw new Error(err.error || 'Payment failed');
                });
            }
            return payResponse.json();
        })
        .then(payData => ({ orderData, payData }));
    })
    .then(({ orderData, payData }) => {
        if (paymentMethod === 'wallet') {
            window.modal?.success('Payment Successful!', 'Your order is being processed', {
                actions: [{
                    label: 'View Order',
                    style: 'primary',
                    onClick: () => window.location.href = `/orders/${orderData.order_id}/`
                }]
            });
        } else {
            window.location.href = `/orders/${orderData.order_id}/?pay=crypto`;
        }
    })
    .catch(error => {
        window.modal?.error('Error', error.message);
    });
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-US').format(num);
}
</script>
{% endblock %}
