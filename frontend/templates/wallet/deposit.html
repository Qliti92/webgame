{% extends 'base.html' %}

{% block title %}Deposit - TOPUPGAMEMOBILE{% endblock %}

{% block meta_description %}Deposit funds to your wallet using USDT TRC20. Secure and fast crypto payments.{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <ol class="flex items-center space-x-2">
            <li><a href="/dashboard/" class="text-dark-400 hover:text-primary-400 transition-colors">Dashboard</a></li>
            <li><i class="fas fa-chevron-right text-dark-600 text-xs"></i></li>
            <li class="text-white">Deposit</li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Deposit Form -->
        <div class="lg:col-span-2">
            <div class="card p-6 md:p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fab fa-bitcoin text-3xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white mb-2">Crypto Deposit</h1>
                    <p class="text-dark-400">Send USDT TRC20 to your wallet</p>
                </div>

                <form id="depositForm" class="space-y-6">
                    <!-- Amount -->
                    <div>
                        <label class="form-label">
                            <i class="fas fa-dollar-sign mr-1"></i>
                            Amount (USD) <span class="text-red-400">*</span>
                        </label>
                        <input
                            type="number"
                            id="amount"
                            step="0.01"
                            min="1"
                            placeholder="Enter amount"
                            required
                            class="form-input"
                        >
                    </div>

                    <!-- Admin Wallet -->
                    <div>
                        <label class="form-label">
                            <i class="fas fa-wallet mr-1"></i>
                            Send USDT to this address
                        </label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="adminAddress"
                                readonly
                                class="form-input flex-1 bg-dark-800 text-sm font-mono"
                            >
                            <button
                                type="button"
                                onclick="copyAddress()"
                                class="btn btn-primary px-4"
                                title="Copy"
                            >
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <!-- From Address -->
                    <div>
                        <label class="form-label">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            Your Wallet Address (Optional)
                        </label>
                        <input
                            type="text"
                            id="fromAddress"
                            placeholder="Your sending wallet address"
                            class="form-input"
                        >
                    </div>

                    <!-- TX Hash -->
                    <div>
                        <label class="form-label">
                            <i class="fas fa-hashtag mr-1"></i>
                            Transaction Hash <span class="text-red-400">*</span>
                        </label>
                        <input
                            type="text"
                            id="txHash"
                            placeholder="Transaction hash after transfer"
                            required
                            class="form-input"
                        >
                        <p class="text-xs text-dark-500 mt-1">Paste TX hash after sending USDT</p>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-primary-500/10 border border-primary-500/20 rounded-xl p-4">
                        <p class="font-semibold text-primary-400 mb-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            How to Deposit:
                        </p>
                        <ol class="list-decimal list-inside text-sm text-dark-300 space-y-1">
                            <li>Copy the wallet address above</li>
                            <li>Send USDT (TRC20) to the address</li>
                            <li>Copy the transaction hash</li>
                            <li>Paste hash and submit</li>
                            <li>Wait 5-30 minutes for confirmation</li>
                        </ol>
                    </div>

                    <!-- Submit -->
                    <button type="submit" class="w-full btn btn-primary btn-glow py-4 text-lg" id="submitBtn">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Submit Deposit
                    </button>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Balance -->
            <div class="card p-6">
                <h3 class="font-semibold text-white mb-3">
                    <i class="fas fa-wallet text-green-400 mr-2"></i>
                    Current Balance
                </h3>
                <p class="text-3xl font-bold text-green-400" id="currentBalance">$0.00</p>
            </div>

            <!-- Quick Links -->
            <div class="card p-6">
                <h3 class="font-semibold text-white mb-3">
                    <i class="fas fa-link text-primary-400 mr-2"></i>
                    Quick Links
                </h3>
                <div class="space-y-2">
                    <a href="/wallet/deposits/" class="block px-4 py-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-sm text-dark-300 hover:text-white transition-colors">
                        <i class="fas fa-history mr-2"></i>Deposit History
                    </a>
                    <a href="/dashboard/" class="block px-4 py-2 rounded-lg bg-dark-700 hover:bg-dark-600 text-sm text-dark-300 hover:text-white transition-colors">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem('access_token');

if (!token) {
    window.location.href = '/login/';
}

document.addEventListener('DOMContentLoaded', function() {
    loadWalletInfo();
    loadAdminAddress();
});

async function loadWalletInfo() {
    try {
        const response = await fetch('/api/wallets/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const data = await response.json();
            document.getElementById('currentBalance').textContent = '$' + parseFloat(data.balance || 0).toFixed(2);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadAdminAddress() {
    try {
        const response = await fetch('/api/wallets/admin-address/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const data = await response.json();
            document.getElementById('adminAddress').value = data.admin_address;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function copyAddress() {
    const input = document.getElementById('adminAddress');
    input.select();
    document.execCommand('copy');
    window.modal?.success('Copied!', 'Wallet address copied to clipboard', { autoClose: true, autoCloseDelay: 1500 });
}

document.getElementById('depositForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('submitBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
    btn.disabled = true;

    const formData = {
        amount: parseFloat(document.getElementById('amount').value),
        from_address: document.getElementById('fromAddress').value,
        tx_hash: document.getElementById('txHash').value
    };

    try {
        const response = await fetch('/api/wallets/crypto-deposits/create/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
            window.modal?.success('Deposit Submitted!', 'Please wait for admin confirmation (5-30 minutes)', {
                actions: [{
                    label: 'View History',
                    style: 'primary',
                    onClick: () => window.location.href = '/wallet/deposits/'
                }]
            });
            document.getElementById('depositForm').reset();
        } else {
            let errorMsg = 'An error occurred';
            if (data.tx_hash) errorMsg = data.tx_hash[0];
            else if (data.amount) errorMsg = data.amount[0];
            else if (data.detail) errorMsg = data.detail;
            window.modal?.error('Error', errorMsg);
        }
    } catch (error) {
        window.modal?.error('Error', 'Connection error. Please try again.');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});
</script>
{% endblock %}
