{% extends 'base.html' %}

{% block title %}Forgot Password - TOPUPGAMEMOBILE{% endblock %}

{% block meta_description %}Reset your TOPUPGAMEMOBILE password. Enter your email to receive a password reset link.{% endblock %}

{% block content %}
<div class="min-h-[70vh] flex items-center justify-center py-8">
    <div class="w-full max-w-md">
        <!-- Forgot Password Card -->
        <div class="card p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-key text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Forgot Password?</h1>
                <p class="text-dark-400">Enter your email to reset your password</p>
            </div>

            <!-- Forgot Password Form -->
            <form id="forgotPasswordForm" class="space-y-5">
                <!-- Email -->
                <div>
                    <label class="form-label">
                        <i class="fas fa-envelope mr-1"></i>
                        Email Address <span class="text-red-400">*</span>
                    </label>
                    <input
                        type="email"
                        id="email"
                        placeholder="Enter your registered email"
                        required
                        class="form-input"
                        autocomplete="email"
                    >
                </div>

                <!-- CAPTCHA -->
                <div>
                    <label class="form-label">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Security Check
                    </label>
                    <div class="flex items-center space-x-3 mb-3">
                        <img id="captchaImage" src="" alt="CAPTCHA" class="h-12 rounded-lg bg-dark-700 border border-dark-600" style="min-width: 120px;">
                        <button type="button" id="refreshCaptcha" class="p-3 bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors border border-dark-600">
                            <i class="fas fa-sync-alt text-dark-400"></i>
                        </button>
                    </div>
                    <input type="hidden" id="captchaKey" name="captcha_0">
                    <input
                        type="text"
                        id="captchaValue"
                        name="captcha_1"
                        required
                        placeholder="Enter the text above"
                        class="form-input"
                    >
                </div>

                <!-- Info Box -->
                <div class="bg-primary-500/10 border border-primary-500/20 rounded-xl p-4">
                    <p class="text-sm text-dark-300">
                        <i class="fas fa-info-circle text-primary-400 mr-2"></i>
                        We'll send a password reset link to your email if it's registered in our system.
                    </p>
                </div>

                <!-- Submit -->
                <button type="submit" class="w-full btn btn-primary btn-glow py-3" id="submitBtn">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Send Reset Link
                </button>

                <!-- Links -->
                <div class="space-y-2 text-center">
                    <p class="text-dark-400 text-sm">
                        Remember your password?
                        <a href="/login/" class="text-primary-400 hover:text-primary-300 font-semibold transition-colors">
                            Sign in
                        </a>
                    </p>
                    <p class="text-dark-400 text-sm">
                        Don't have an account?
                        <a href="/register/" class="text-primary-400 hover:text-primary-300 font-semibold transition-colors">
                            Register now
                        </a>
                    </p>
                </div>
            </form>
        </div>

        <!-- Trust Badges -->
        <div class="mt-6 flex justify-center space-x-6 text-xs text-dark-500">
            <div class="flex items-center">
                <i class="fas fa-shield-alt mr-1"></i>
                <span>Secure</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-lock mr-1"></i>
                <span>Encrypted</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-headset mr-1"></i>
                <span>24/7 Support</span>
            </div>
        </div>
    </div>
</div>

<script>
// Load CAPTCHA
async function loadCaptcha() {
    try {
        const response = await fetch('/captcha/refresh/', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();
        document.getElementById('captchaImage').src = data.image_url;
        document.getElementById('captchaKey').value = data.key;
    } catch (error) {
        console.error('Error loading CAPTCHA:', error);
    }
}

document.getElementById('refreshCaptcha')?.addEventListener('click', loadCaptcha);
loadCaptcha();

// Check if already logged in
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    if (token) {
        window.location.href = '/dashboard/';
    }
});

// Form submission
document.getElementById('forgotPasswordForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('submitBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    btn.disabled = true;

    const formData = {
        email: document.getElementById('email').value.trim(),
        captcha: [
            document.getElementById('captchaKey').value,
            document.getElementById('captchaValue').value
        ]
    };

    try {
        const response = await fetch('/api/users/forgot-password/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
            window.modal?.success('Email Sent!', data.message || 'If your email is registered, you will receive a password reset link shortly.', {
                actions: [{
                    label: 'Back to Login',
                    style: 'primary',
                    onClick: () => window.location.href = '/login/'
                }]
            });
            document.getElementById('forgotPasswordForm').reset();
            loadCaptcha();
        } else {
            let errorMsg = 'An error occurred';
            if (data.captcha) errorMsg = 'Invalid CAPTCHA. Please try again.';
            else if (data.email) errorMsg = Array.isArray(data.email) ? data.email[0] : data.email;
            else if (data.detail) errorMsg = data.detail;

            window.modal?.error('Error', errorMsg);
            loadCaptcha();
            document.getElementById('captchaValue').value = '';
        }
    } catch (error) {
        window.modal?.error('Error', 'Connection error. Please try again.');
        loadCaptcha();
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});
</script>
{% endblock %}
