{% extends 'base.html' %}

{% block title %}Dashboard - Game TopUp{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- User Info Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-lg p-8 text-white mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-user-circle mr-2"></i>
                    <span data-i18n="dashboard.hello">Hello</span>, <span id="userName">User</span>!
                </h1>
                <p class="text-blue-100" id="userEmail"></p>
            </div>
            <button onclick="logout()" class="px-6 py-3 bg-white text-blue-600 rounded-lg font-semibold hover:bg-gray-100 transition">
                <i class="fas fa-sign-out-alt mr-2"></i>
                <span data-i18n="nav.logout">Logout</span>
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Wallet Balance -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-wallet text-2xl text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm" data-i18n="dashboard.walletBalance">Wallet Balance</p>
                        <p class="text-2xl font-bold text-gray-800" id="walletBalance">$0.00</p>
                    </div>
                </div>
            </div>
            <a href="/wallet/deposit/" class="block text-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-plus mr-2"></i>
                <span data-i18n="dashboard.depositMoney">Deposit Money</span>
            </a>
        </div>

        <!-- Total Orders -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-shopping-cart text-2xl text-blue-600"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-sm" data-i18n="dashboard.totalOrders">Total Orders</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalOrders">0</p>
                </div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-clock text-2xl text-yellow-600"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-sm" data-i18n="dashboard.pendingOrders">Pending Orders</p>
                    <p class="text-2xl font-bold text-gray-800" id="pendingOrders">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Tab Headers -->
        <div class="border-b border-gray-200">
            <div class="flex">
                <button onclick="switchTab('orders')" id="ordersTab" class="tab-button px-6 py-4 font-semibold border-b-2 border-blue-600 text-blue-600">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    <span data-i18n="dashboard.orders">Đơn hàng</span>
                </button>
                <button onclick="switchTab('transactions')" id="transactionsTab" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-gray-800">
                    <i class="fas fa-history mr-2"></i>
                    <span data-i18n="dashboard.transactions">Lịch sử giao dịch</span>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Orders Tab -->
            <div id="ordersContent">
                <div id="ordersList" class="space-y-4">
                    <!-- Orders will be loaded here -->
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i>
                        <p class="text-gray-500 mt-2" data-i18n="common.loading">Đang tải...</p>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsContent" class="hidden">
                <div id="transactionsList" class="space-y-4">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem('access_token');

if (!token) {
    window.location.href = '/login/';
}

document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();
    loadWalletInfo();
    loadOrders();
    loadTransactions();

    // Apply translations
    if (typeof applyTranslations === 'function') {
        applyTranslations();
    }
});

async function loadUserInfo() {
    try {
        const response = await fetch('/api/users/profile/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('userName').textContent = data.username;
            document.getElementById('userEmail').textContent = data.email;
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

async function loadWalletInfo() {
    try {
        const response = await fetch('/api/wallets/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('walletBalance').textContent = formatCurrency(data.balance);
        }
    } catch (error) {
        console.error('Error loading wallet:', error);
    }
}

async function loadOrders() {
    try {
        const response = await fetch('/api/orders/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('totalOrders').textContent = data.count || data.results.length;

            const pending = data.results.filter(o => ['pending_payment', 'paid', 'processing'].includes(o.status)).length;
            document.getElementById('pendingOrders').textContent = pending;

            displayOrders(data.results);
        }
    } catch (error) {
        console.error('Error loading orders:', error);
    }
}

function displayOrders(orders) {
    const container = document.getElementById('ordersList');
    container.innerHTML = '';

    if (orders.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-500">${t('dashboard.noOrders', 'Chưa có đơn hàng nào')}</p>
                <a href="/games/" class="inline-block mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ${t('dashboard.createNewOrder', 'Tạo đơn hàng mới')}
                </a>
            </div>
        `;
        return;
    }

    orders.forEach(order => {
        const statusColors = {
            'pending_payment': 'bg-yellow-100 text-yellow-800',
            'paid': 'bg-blue-100 text-blue-800',
            'processing': 'bg-purple-100 text-purple-800',
            'completed': 'bg-green-100 text-green-800',
            'canceled': 'bg-gray-100 text-gray-800',
            'refunded': 'bg-red-100 text-red-800'
        };

        const statusTexts = {
            'pending_payment': t('order.status.pending_payment', 'Chờ thanh toán'),
            'paid': t('order.status.paid', 'Đã thanh toán'),
            'processing': t('order.status.processing', 'Đang xử lý'),
            'completed': t('order.status.completed', 'Hoàn thành'),
            'canceled': t('order.status.canceled', 'Đã hủy'),
            'refunded': t('order.status.refunded', 'Đã hoàn tiền')
        };

        const div = document.createElement('div');
        div.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition';
        div.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="font-semibold text-lg">${order.game_name}</p>
                    <p class="text-sm text-gray-600">${t('dashboard.orderId', 'Mã đơn')}: ${order.order_id}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColors[order.status]}">
                    ${statusTexts[order.status]}
                </span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                <div class="text-gray-600">${t('dashboard.amount', 'Giá trị')}:</div>
                <div class="font-semibold text-right">${formatCurrency(order.price)}</div>
                <div class="text-gray-600">${t('order.method', 'Phương thức')}:</div>
                <div class="text-right">${order.payment_method === 'wallet' ? t('gameDetail.wallet', 'Ví nội bộ') : 'Crypto'}</div>
            </div>
            <div class="text-right">
                <a href="/orders/${order.order_id}/" class="text-blue-600 hover:text-blue-800 font-semibold">
                    ${t('dashboard.viewDetails', 'Chi tiết')} →
                </a>
            </div>
        `;
        container.appendChild(div);
    });
}

async function loadTransactions() {
    try {
        const response = await fetch('/api/wallets/transactions/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            displayTransactions(data.results || data);
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
    }
}

function displayTransactions(transactions) {
    const container = document.getElementById('transactionsList');
    container.innerHTML = '';

    if (transactions.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 py-8">${t('dashboard.noTransactions', 'Chưa có giao dịch nào')}</p>`;
        return;
    }

    transactions.forEach(tx => {
        const div = document.createElement('div');
        div.className = 'border border-gray-200 rounded-lg p-4';
        div.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-semibold">${tx.description}</p>
                    <p class="text-sm text-gray-600">${new Date(tx.created_at).toLocaleString('vi-VN')}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold ${tx.transaction_type === 'deposit' || tx.transaction_type === 'refund' ? 'text-green-600' : 'text-red-600'}">
                        ${tx.transaction_type === 'deposit' || tx.transaction_type === 'refund' ? '+' : '-'}${formatCurrency(tx.amount)}
                    </p>
                    <p class="text-sm text-gray-600">${t('dashboard.balanceAfter', 'Số dư')}: ${formatCurrency(tx.balance_after)}</p>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function switchTab(tab) {
    // Hide all content
    document.getElementById('ordersContent').classList.add('hidden');
    document.getElementById('transactionsContent').classList.add('hidden');

    // Remove active state from all tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-blue-600', 'text-blue-600');
        btn.classList.add('text-gray-600');
    });

    // Show selected content
    if (tab === 'orders') {
        document.getElementById('ordersContent').classList.remove('hidden');
        document.getElementById('ordersTab').classList.add('border-blue-600', 'text-blue-600');
    } else {
        document.getElementById('transactionsContent').classList.remove('hidden');
        document.getElementById('transactionsTab').classList.add('border-blue-600', 'text-blue-600');
    }
}

function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    window.location.href = '/';
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}
</script>
{% endblock %}
