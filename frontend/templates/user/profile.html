{% extends 'base.html' %}

{% block title %}Profile Settings - TOPUPGAMEMOBILE{% endblock %}

{% block meta_description %}Manage your profile settings, change password, and view login history.{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <ol class="flex items-center space-x-2">
            <li><a href="/dashboard/" class="text-dark-400 hover:text-primary-400 transition-colors">Dashboard</a></li>
            <li><i class="fas fa-chevron-right text-dark-600 text-xs"></i></li>
            <li class="text-white">Profile Settings</li>
        </ol>
    </nav>

    <!-- Profile Header -->
    <div class="card p-6 md:p-8 mb-8 bg-gradient-to-r from-primary-600/20 to-pink-600/20 border-primary-500/30">
        <div class="flex flex-col sm:flex-row items-center">
            <div class="relative mb-4 sm:mb-0">
                <img id="avatarPreview" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff"
                     class="w-24 h-24 rounded-2xl border-4 border-primary-500/50 shadow-lg object-cover">
                <label for="avatarInput" class="absolute bottom-0 right-0 bg-primary-600 rounded-full p-2 cursor-pointer shadow-lg hover:bg-primary-500 transition-colors">
                    <i class="fas fa-camera text-white text-sm"></i>
                </label>
                <input type="file" id="avatarInput" accept="image/*" class="hidden">
            </div>
            <div class="sm:ml-6 text-center sm:text-left">
                <h1 class="text-2xl font-bold text-white" id="displayName">User</h1>
                <p class="text-dark-400" id="displayEmail">user@email.com</p>
                <p class="text-sm text-dark-500 mt-1">
                    <i class="fas fa-calendar mr-1"></i>
                    Member since: <span id="memberSince">-</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="card overflow-hidden">
        <div class="border-b border-dark-700">
            <div class="flex">
                <button onclick="switchTab('profile')" id="profileTab" class="tab-button px-6 py-4 font-semibold border-b-2 border-primary-500 text-primary-400">
                    <i class="fas fa-user mr-2"></i>Profile
                </button>
                <button onclick="switchTab('password')" id="passwordTab" class="tab-button px-6 py-4 font-semibold text-dark-400 hover:text-white border-b-2 border-transparent">
                    <i class="fas fa-lock mr-2"></i>Password
                </button>
                <button onclick="switchTab('history')" id="historyTab" class="tab-button px-6 py-4 font-semibold text-dark-400 hover:text-white border-b-2 border-transparent">
                    <i class="fas fa-history mr-2"></i>History
                </button>
            </div>
        </div>

        <div class="p-6">
            <!-- Profile Tab -->
            <div id="profileContent">
                <h2 class="text-xl font-bold text-white mb-6">
                    <i class="fas fa-user-edit text-primary-400 mr-2"></i>
                    Profile Information
                </h2>

                <form id="profileForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">First Name</label>
                            <input type="text" id="firstName" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Last Name</label>
                            <input type="text" id="lastName" class="form-input">
                        </div>
                    </div>

                    <div>
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="phone" placeholder="+1234567890" class="form-input">
                    </div>

                    <div>
                        <label class="form-label">Date of Birth</label>
                        <input type="date" id="dateOfBirth" class="form-input">
                    </div>

                    <div>
                        <label class="form-label">Address</label>
                        <textarea id="address" rows="2" class="form-input"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">
                                <i class="fab fa-telegram mr-1 text-blue-400"></i>Telegram
                            </label>
                            <input type="text" id="telegram" placeholder="@username" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">
                                <i class="fab fa-facebook mr-1 text-blue-500"></i>Facebook
                            </label>
                            <input type="url" id="facebook" placeholder="https://facebook.com/..." class="form-input">
                        </div>
                    </div>

                    <button type="submit" id="saveProfileBtn" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </form>
            </div>

            <!-- Password Tab -->
            <div id="passwordContent" class="hidden">
                <h2 class="text-xl font-bold text-white mb-6">
                    <i class="fas fa-key text-yellow-400 mr-2"></i>
                    Change Password
                </h2>

                <form id="passwordForm" class="space-y-4 max-w-md">
                    <div>
                        <label class="form-label">Current Password</label>
                        <input type="password" id="oldPassword" required class="form-input">
                    </div>

                    <div>
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" required minlength="8" class="form-input">
                        <p class="mt-1 text-xs text-dark-500">Minimum 8 characters</p>
                    </div>

                    <div>
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" required minlength="8" class="form-input">
                    </div>

                    <button type="submit" id="changePasswordBtn" class="btn btn-primary">
                        <i class="fas fa-key mr-2"></i>Change Password
                    </button>
                </form>
            </div>

            <!-- Login History Tab -->
            <div id="historyContent" class="hidden">
                <h2 class="text-xl font-bold text-white mb-6">
                    <i class="fas fa-history text-purple-400 mr-2"></i>
                    Login History
                </h2>
                <p class="text-dark-400 mb-4">Recent login attempts to your account</p>

                <div id="loginHistoryList" class="space-y-3">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary-500 mx-auto"></div>
                        <p class="text-dark-400 mt-3">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Dashboard -->
    <div class="mt-6">
        <a href="/dashboard/" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<script>
const token = localStorage.getItem('access_token');

if (!token) {
    window.location.href = '/login/';
}

let currentUserData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
    loadLoginHistory();
});

async function loadProfile() {
    try {
        const response = await fetch('/api/users/profile/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            currentUserData = await response.json();
            populateProfile(currentUserData);
        }
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

function populateProfile(data) {
    document.getElementById('displayName').textContent = data.username;
    document.getElementById('displayEmail').textContent = data.email;
    document.getElementById('memberSince').textContent = new Date(data.created_at).toLocaleDateString('en-US');

    if (data.profile && data.profile.avatar_url) {
        document.getElementById('avatarPreview').src = data.profile.avatar_url;
    } else {
        document.getElementById('avatarPreview').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.username)}&background=6366f1&color=fff`;
    }

    document.getElementById('firstName').value = data.first_name || '';
    document.getElementById('lastName').value = data.last_name || '';
    document.getElementById('phone').value = data.phone || '';

    if (data.profile) {
        document.getElementById('dateOfBirth').value = data.profile.date_of_birth || '';
        document.getElementById('address').value = data.profile.address || '';
        document.getElementById('telegram').value = data.profile.telegram || '';
        document.getElementById('facebook').value = data.profile.facebook || '';
    }
}

// Avatar upload
document.getElementById('avatarInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('avatarPreview').src = e.target.result;
    };
    reader.readAsDataURL(file);

    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const response = await fetch('/api/users/profile/update/', {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (response.ok) {
            window.modal?.success('Success', 'Avatar updated successfully');
        } else {
            window.modal?.error('Error', 'Failed to upload avatar');
        }
    } catch (error) {
        window.modal?.error('Error', 'Error uploading avatar');
    }
});

// Profile form
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append('first_name', document.getElementById('firstName').value);
    formData.append('last_name', document.getElementById('lastName').value);
    formData.append('phone', document.getElementById('phone').value);
    formData.append('date_of_birth', document.getElementById('dateOfBirth').value);
    formData.append('address', document.getElementById('address').value);
    formData.append('telegram', document.getElementById('telegram').value);
    formData.append('facebook', document.getElementById('facebook').value);

    const btn = document.getElementById('saveProfileBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

    try {
        const response = await fetch('/api/users/profile/update/', {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (response.ok) {
            window.modal?.success('Success', 'Profile updated successfully');
            loadProfile();
        } else {
            const data = await response.json();
            window.modal?.error('Error', data.detail || 'Failed to update profile');
        }
    } catch (error) {
        window.modal?.error('Error', 'Error updating profile');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Password form
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;

    if (newPassword !== confirmPassword) {
        window.modal?.error('Error', 'New passwords do not match');
        return;
    }

    const btn = document.getElementById('changePasswordBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Changing...';

    try {
        const response = await fetch('/api/users/change-password/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword,
                new_password_confirm: confirmPassword
            })
        });

        if (response.ok) {
            window.modal?.success('Success', 'Password changed successfully');
            document.getElementById('passwordForm').reset();
        } else {
            const data = await response.json();
            const errorMsg = data.old_password || data.new_password || data.detail || 'Failed to change password';
            window.modal?.error('Error', errorMsg);
        }
    } catch (error) {
        window.modal?.error('Error', 'Error changing password');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

async function loadLoginHistory() {
    try {
        const response = await fetch('/api/users/login-history/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const data = await response.json();
            displayLoginHistory(data);
        }
    } catch (error) {
        console.error('Error loading login history:', error);
    }
}

function displayLoginHistory(attempts) {
    const container = document.getElementById('loginHistoryList');
    container.innerHTML = '';

    if (!attempts || attempts.length === 0) {
        container.innerHTML = '<p class="text-center text-dark-400 py-8">No login history available</p>';
        return;
    }

    attempts.forEach(attempt => {
        const div = document.createElement('div');
        const isSuccess = attempt.success;
        div.className = `card p-4 ${isSuccess ? 'border-green-500/30 bg-green-500/5' : 'border-red-500/30 bg-red-500/5'}`;

        const statusIcon = isSuccess
            ? '<i class="fas fa-check-circle text-green-400"></i>'
            : '<i class="fas fa-times-circle text-red-400"></i>';
        const statusText = isSuccess ? 'Successful' : 'Failed';
        const statusClass = isSuccess ? 'text-green-400' : 'text-red-400';

        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-semibold ${statusClass}">
                        ${statusIcon} ${statusText}
                    </p>
                    <p class="text-sm text-dark-400 mt-1">
                        <i class="fas fa-map-marker-alt mr-1"></i>IP: ${attempt.ip_address}
                    </p>
                    <p class="text-xs text-dark-500 mt-1 truncate max-w-xs" title="${attempt.user_agent}">
                        <i class="fas fa-desktop mr-1"></i>${attempt.user_agent.substring(0, 50)}...
                    </p>
                </div>
                <div class="text-right text-sm text-dark-500">
                    ${new Date(attempt.created_at).toLocaleDateString('en-US')}<br>
                    ${new Date(attempt.created_at).toLocaleTimeString('en-US')}
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function switchTab(tab) {
    document.getElementById('profileContent').classList.add('hidden');
    document.getElementById('passwordContent').classList.add('hidden');
    document.getElementById('historyContent').classList.add('hidden');

    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-primary-500', 'text-primary-400');
        btn.classList.add('border-transparent', 'text-dark-400');
    });

    document.getElementById(`${tab}Content`).classList.remove('hidden');
    const activeTab = document.getElementById(`${tab}Tab`);
    activeTab.classList.add('border-primary-500', 'text-primary-400');
    activeTab.classList.remove('border-transparent', 'text-dark-400');
}
</script>
{% endblock %}
