{% extends 'base.html' %}

{% block title %}Order #{{ order_id }} - TOPUPGAMEMOBILE{% endblock %}

{% block meta_description %}View details and status of your game top-up order.{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <ol class="flex items-center space-x-2">
            <li><a href="/dashboard/" class="text-dark-400 hover:text-primary-400 transition-colors">Dashboard</a></li>
            <li><i class="fas fa-chevron-right text-dark-600 text-xs"></i></li>
            <li class="text-white">Order Details</li>
        </ol>
    </nav>

    <!-- Order Header -->
    <div class="card p-6 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-2xl font-bold text-white mb-1">
                    <i class="fas fa-receipt text-primary-400 mr-2"></i>
                    Order #<span id="orderIdDisplay">{{ order_id }}</span>
                </h1>
                <p class="text-dark-400 text-sm" id="orderDate"></p>
            </div>
            <span id="orderStatus" class="mt-3 sm:mt-0 px-4 py-2 rounded-full text-sm font-semibold"></span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Game Info -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-gamepad text-primary-400 mr-2"></i>
                Game Information
            </h2>
            <div class="flex items-center mb-4">
                <img id="gameImage" src="" alt="Game" class="w-16 h-16 rounded-lg mr-4 bg-dark-700">
                <div>
                    <p class="font-semibold text-white" id="gameName">-</p>
                    <p class="text-sm text-dark-400" id="packageName">-</p>
                </div>
            </div>
            <div class="space-y-2 pt-4 border-t border-dark-700">
                <div class="flex justify-between text-sm">
                    <span class="text-dark-400">Amount:</span>
                    <span class="text-white" id="orderAmount">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-400">Total:</span>
                    <span class="text-xl font-bold text-primary-400" id="orderPrice">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Account Info -->
        <div class="card p-6">
            <h2 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-user text-pink-400 mr-2"></i>
                Account Information
            </h2>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-dark-400">UID:</span>
                    <span class="text-white font-mono" id="gameUid">-</span>
                </div>
                <div class="flex justify-between" id="usernameRow">
                    <span class="text-dark-400">Username:</span>
                    <span class="text-white" id="gameUsername">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-400">Payment:</span>
                    <span class="text-white" id="paymentMethod">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Note -->
    <div id="adminNoteSection" class="hidden mb-6">
        <div class="card p-6 border-green-500/50 bg-green-500/5">
            <h2 class="text-lg font-bold text-white mb-3">
                <i class="fas fa-comment text-green-400 mr-2"></i>
                Admin Note
            </h2>
            <p id="adminNote" class="text-dark-300"></p>
        </div>
    </div>

    <!-- Proof Attachments -->
    <div id="attachmentsSection" class="hidden mb-6">
        <div class="card p-6">
            <h2 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-images text-green-400 mr-2"></i>
                Proof of Completion
            </h2>
            <div id="attachmentsList" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <!-- Status Timeline -->
    <div class="card p-6 mb-6">
        <h2 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-history text-purple-400 mr-2"></i>
            Order History
        </h2>
        <div id="statusLogs" class="space-y-4"></div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4">
        <a href="/dashboard/" class="btn btn-secondary flex-1">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
        <button id="paymentBtn" onclick="proceedToPayment()" class="hidden btn btn-primary flex-1">
            <i class="fas fa-credit-card mr-2"></i>Pay Now
        </button>
        <button id="cancelBtn" onclick="cancelOrder()" class="hidden btn btn-outline border-red-500 text-red-400 hover:bg-red-500 hover:text-white flex-1">
            <i class="fas fa-times mr-2"></i>Cancel Order
        </button>
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 p-4">
    <div class="card p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-white mb-6">
            <i class="fas fa-credit-card text-primary-400 mr-2"></i>
            Select Payment Method
        </h2>
        <form id="paymentForm">
            <div class="space-y-3 mb-6">
                <label class="payment-option cursor-pointer block">
                    <input type="radio" name="paymentMethod" value="wallet" class="hidden">
                    <div class="card p-4 hover:border-primary-500 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-wallet text-2xl text-primary-400 mr-3"></i>
                            <div>
                                <p class="font-semibold text-white">Internal Wallet</p>
                                <p class="text-sm text-dark-400">Balance: <span id="modalWalletBalance">$0.00</span></p>
                            </div>
                        </div>
                    </div>
                </label>
                <label class="payment-option cursor-pointer block">
                    <input type="radio" name="paymentMethod" value="crypto" class="hidden">
                    <div class="card p-4 hover:border-primary-500 transition-colors">
                        <div class="flex items-center">
                            <i class="fab fa-bitcoin text-2xl text-yellow-500 mr-3"></i>
                            <div>
                                <p class="font-semibold text-white">Crypto</p>
                                <p class="text-sm text-dark-400">USDT TRC20</p>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closePaymentModal()" class="flex-1 btn btn-secondary">Cancel</button>
                <button type="submit" class="flex-1 btn btn-primary">Confirm</button>
            </div>
        </form>
    </div>
</div>

<!-- Crypto Deposit Modal -->
<div id="cryptoDepositModal" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="card p-6 max-w-lg w-full my-8">
        <h2 class="text-xl font-bold text-white mb-6">
            <i class="fab fa-bitcoin text-yellow-500 mr-2"></i>
            Crypto Deposit (USDT TRC20)
        </h2>
        <form id="cryptoDepositForm">
            <div class="space-y-4 mb-6">
                <div>
                    <label class="form-label">Amount (USD)</label>
                    <input type="number" id="cryptoAmount" readonly class="form-input bg-dark-800 font-bold text-lg">
                </div>
                <div>
                    <label class="form-label">Send USDT to this address</label>
                    <div class="flex gap-2">
                        <input type="text" id="cryptoAdminAddress" readonly class="form-input flex-1 bg-dark-800 text-xs font-mono">
                        <button type="button" onclick="copyCryptoAddress()" class="btn btn-primary px-4">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="form-label">Your Wallet Address (Optional)</label>
                    <input type="text" id="cryptoFromAddress" placeholder="Your sending wallet address" class="form-input">
                </div>
                <div>
                    <label class="form-label">Transaction Hash <span class="text-red-400">*</span></label>
                    <input type="text" id="cryptoTxHash" placeholder="TX hash after transfer" required class="form-input">
                </div>
            </div>
            <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4 mb-6">
                <p class="font-semibold text-yellow-400 mb-2 text-sm">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    Instructions:
                </p>
                <ol class="list-decimal list-inside text-xs text-dark-300 space-y-1">
                    <li>Send exactly <strong id="cryptoAmountInstructions">$0</strong> USDT (TRC20)</li>
                    <li>Paste TX hash and submit</li>
                    <li>Wait 5-30 min for verification</li>
                </ol>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeCryptoDepositModal()" class="flex-1 btn btn-secondary">Cancel</button>
                <button type="submit" class="flex-1 btn btn-success">Submit Deposit</button>
            </div>
        </form>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-50 p-4" onclick="closeImageModal()">
    <img id="modalImage" src="" alt="Preview" class="max-w-full max-h-full object-contain">
</div>

<script>
const orderId = '{{ order_id }}';
let orderData = null;
const token = localStorage.getItem('access_token');

if (!token) {
    window.location.href = '/login/';
}

document.addEventListener('DOMContentLoaded', function() {
    loadOrderDetail();
    loadWalletBalance();
    loadAdminAddress();
    setupPaymentSelection();

    document.getElementById('paymentForm').addEventListener('submit', handlePayment);
    document.getElementById('cryptoDepositForm').addEventListener('submit', handleCryptoDeposit);

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('pay') === 'crypto') {
        setTimeout(() => {
            if (orderData && orderData.status === 'pending_payment') {
                showCryptoDepositModal();
            }
        }, 500);
    }
});

function setupPaymentSelection() {
    document.querySelectorAll('.payment-option').forEach(label => {
        label.addEventListener('click', function() {
            document.querySelectorAll('.payment-option .card').forEach(div => {
                div.classList.remove('border-primary-500', 'bg-primary-500/10');
            });
            this.querySelector('.card').classList.add('border-primary-500', 'bg-primary-500/10');
        });
    });
}

function loadOrderDetail() {
    fetch(`/api/orders/${orderId}/`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        if (!response.ok) throw new Error('Order not found');
        return response.json();
    })
    .then(order => {
        orderData = order;
        displayOrderDetail(order);
    })
    .catch(error => {
        window.modal?.error('Error', 'Unable to load order', {
            actions: [{ label: 'Go Back', style: 'primary', onClick: () => window.location.href = '/dashboard/' }]
        });
    });
}

function displayOrderDetail(order) {
    document.getElementById('orderIdDisplay').textContent = order.order_id;
    document.getElementById('orderDate').textContent = new Date(order.created_at).toLocaleString('en-US');

    const statusConfig = {
        'pending_payment': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', label: 'Pending Payment' },
        'paid': { bg: 'bg-blue-500/20', text: 'text-blue-400', label: 'Paid' },
        'processing': { bg: 'bg-purple-500/20', text: 'text-purple-400', label: 'Processing' },
        'completed': { bg: 'bg-green-500/20', text: 'text-green-400', label: 'Completed' },
        'canceled': { bg: 'bg-dark-600', text: 'text-dark-400', label: 'Canceled' },
        'refunded': { bg: 'bg-red-500/20', text: 'text-red-400', label: 'Refunded' }
    };

    const status = statusConfig[order.status] || statusConfig['pending_payment'];
    const statusEl = document.getElementById('orderStatus');
    statusEl.className = `px-4 py-2 rounded-full text-sm font-semibold ${status.bg} ${status.text}`;
    statusEl.textContent = status.label;

    document.getElementById('gameImage').src = order.game_image || '/static/images/game-placeholder.png';
    document.getElementById('gameName').textContent = order.game_name;
    document.getElementById('packageName').textContent = order.package_name || '-';
    document.getElementById('orderAmount').textContent = formatCurrency(order.amount);
    document.getElementById('orderPrice').textContent = formatCurrency(order.price);

    document.getElementById('gameUid').textContent = order.game_uid;
    document.getElementById('gameUsername').textContent = order.game_username || '-';

    const paymentMethods = { 'wallet': 'Internal Wallet', 'crypto': 'Crypto (USDT)' };
    document.getElementById('paymentMethod').textContent = paymentMethods[order.payment_method] || 'Not selected';

    if (order.admin_note) {
        document.getElementById('adminNote').textContent = order.admin_note;
        document.getElementById('adminNoteSection').classList.remove('hidden');
    }

    if (order.status_logs) displayStatusLogs(order.status_logs);

    if (order.status === 'pending_payment') {
        document.getElementById('cancelBtn').classList.remove('hidden');
        document.getElementById('paymentBtn').classList.remove('hidden');
    }

    // Load attachments for completed orders
    loadAttachments();
}

function loadAttachments() {
    fetch(`/api/orders/${orderId}/attachments/`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(r => r.json())
    .then(data => {
        // Handle paginated response
        const attachments = data.results || data;
        if (attachments && attachments.length > 0) {
            displayAttachments(attachments);
            document.getElementById('attachmentsSection').classList.remove('hidden');
        }
    })
    .catch(e => console.error(e));
}

function displayAttachments(attachments) {
    const container = document.getElementById('attachmentsList');
    container.innerHTML = attachments.map(att => `
        <div class="relative">
            <img src="${att.file_url}" alt="${att.description || 'Proof'}"
                 class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity"
                 onclick="showImage('${att.file_url}')">
            <div class="absolute bottom-0 left-0 right-0 bg-black/70 p-2 rounded-b-lg">
                <p class="text-xs text-white truncate">${att.description || 'Proof image'}</p>
            </div>
        </div>
    `).join('');
}

function showImage(url) {
    document.getElementById('modalImage').src = url;
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
}

function displayStatusLogs(logs) {
    const container = document.getElementById('statusLogs');
    container.innerHTML = '';

    if (!logs || logs.length === 0) {
        container.innerHTML = '<p class="text-dark-400 text-sm">No history available</p>';
        return;
    }

    logs.forEach((log, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-start';
        div.innerHTML = `
            <div class="w-2 h-2 mt-2 rounded-full ${index === 0 ? 'bg-primary-500' : 'bg-dark-600'}"></div>
            <div class="ml-4 flex-1">
                <div class="flex justify-between items-start">
                    <p class="font-semibold text-white text-sm">${log.note}</p>
                    <p class="text-xs text-dark-500">${new Date(log.created_at).toLocaleString('en-US')}</p>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function loadWalletBalance() {
    fetch('/api/wallets/', { headers: { 'Authorization': `Bearer ${token}` } })
    .then(r => r.json())
    .then(data => { document.getElementById('modalWalletBalance').textContent = formatCurrency(data.balance); })
    .catch(e => console.error(e));
}

function loadAdminAddress() {
    fetch('/api/wallets/admin-address/', { headers: { 'Authorization': `Bearer ${token}` } })
    .then(r => r.json())
    .then(data => { document.getElementById('cryptoAdminAddress').value = data.admin_address; })
    .catch(e => console.error(e));
}

function proceedToPayment() { document.getElementById('paymentModal').classList.remove('hidden'); }
function closePaymentModal() { document.getElementById('paymentModal').classList.add('hidden'); }

function handlePayment(e) {
    e.preventDefault();
    const method = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    if (!method) { window.modal?.error('Error', 'Please select payment method'); return; }

    if (method === 'wallet') {
        fetch(`/api/orders/${orderId}/payment/`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ payment_method: 'wallet' })
        })
        .then(r => r.json().then(d => { if (!r.ok) throw new Error(d.error || 'Payment failed'); return d; }))
        .then(data => {
            window.modal?.success('Payment Successful', data.message || 'Your order is being processed');
            closePaymentModal();
            loadOrderDetail();
        })
        .catch(e => window.modal?.error('Error', e.message));
    } else {
        closePaymentModal();
        showCryptoDepositModal();
    }
}

function showCryptoDepositModal() {
    if (!orderData) return;
    document.getElementById('cryptoAmount').value = orderData.price;
    document.getElementById('cryptoAmountInstructions').textContent = `$${orderData.price}`;
    document.getElementById('cryptoFromAddress').value = '';
    document.getElementById('cryptoTxHash').value = '';
    document.getElementById('cryptoDepositModal').classList.remove('hidden');
}

function closeCryptoDepositModal() { document.getElementById('cryptoDepositModal').classList.add('hidden'); }

function copyCryptoAddress() {
    const input = document.getElementById('cryptoAdminAddress');
    input.select();
    document.execCommand('copy');
    window.modal?.success('Copied!', 'Address copied', { autoClose: true, autoCloseDelay: 1500 });
}

function handleCryptoDeposit(e) {
    e.preventDefault();
    const formData = {
        amount: parseFloat(document.getElementById('cryptoAmount').value),
        from_address: document.getElementById('cryptoFromAddress').value,
        tx_hash: document.getElementById('cryptoTxHash').value,
        related_order: orderData.id
    };

    fetch('/api/wallets/crypto-deposits/create/', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(r => r.json().then(d => {
        if (!r.ok) {
            let msg = d.tx_hash?.[0] || d.amount?.[0] || d.detail || 'Error occurred';
            throw new Error(msg);
        }
        return d;
    }))
    .then(data => {
        closeCryptoDepositModal();
        window.modal?.success('Deposit Submitted!', 'Wait 5-30 min for admin verification', {
            actions: [{ label: 'OK', style: 'primary', onClick: () => loadOrderDetail() }]
        });
    })
    .catch(e => window.modal?.error('Error', e.message));
}

function cancelOrder() {
    window.modal?.show({
        type: 'warning',
        title: 'Cancel Order',
        message: 'Are you sure you want to cancel this order?',
        actions: [
            { label: 'No', style: 'secondary' },
            { label: 'Yes, Cancel', style: 'primary', onClick: () => {
                fetch(`/api/orders/${orderId}/cancel/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(r => r.json().then(d => { if (!r.ok) throw new Error(d.error || 'Cancel failed'); return d; }))
                .then(data => {
                    window.modal?.success('Order Canceled', data.message || 'Success');
                    loadOrderDetail();
                })
                .catch(e => window.modal?.error('Error', e.message));
            }}
        ]
    });
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}
</script>
{% endblock %}
